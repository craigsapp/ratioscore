

<script>
{% include_relative aton.js %}
</script>

<script>
// vim: ts=3:ft=javascript

var LIST = [];

//////////////////////////////
//
// createTemperamentLayout --
//

function createTemperamentLayout() {
	let element = document.querySelector("#display");
	if (!element) {
		console.log("ERROR: missing #display");
		return;
	}

	let felement = document.querySelector("#fifths");
	if (!felement) {
		console.log("ERROR: missing #fifths");
		return;
	}
	let fifths = parseInt(felement.value);

	let telement = document.querySelector("#flatest");
	if (!telement) {
		console.log("ERROR: missing #flatest");
		return;
	}
	let flatest = parseInt(telement.value);

	let celement = document.querySelector("#center");
	if (!celement) {
		console.log("ERROR: missing #center");
		return;
	}
	let center = parseInt(celement.value);
	
	// console.log("FIFTHS", fifths, "FLATEST", flatest, "CENTER", center);
	if (fifths <= 0) {
		return;
	}
	LIST = makePitchEntries(fifths, flatest, center);
	let text = makePitchText(LIST);
	element.innerHTML = text;
	calculateCents();
}



//////////////////////////////
//
// makePitchText --
//

function makePitchText(list) {
	let output = "";
	output += "<table class='fifthlist'>";
	for (let i=0; i<list.length; i++) {
		output += "<tr>";

		output += "<td>";
		output += "<span class='pitchname";
		if (list[i].center) {
			output += " center";
		}
		output += "'>";

		output += list[i].pname;

		output += "</span>"
		output += "</td>";

		output += "<td>";
		if (i < list.length-1) {
			output += "<input onkeyup='calculateCents()' type='text' value='0'>";
		} else {
			output += "<input style='visibility:hidden;' type='text' value='0'>";
		}
		output += "<span class='cents'>x</span>";
		output += "</td>";


		output += "</tr>";
	}
	output += "</table>";
	return output;
}


//////////////////////////////
//
// makePitchEntries --
//

function makePitchEntries(fifths, flatest, center) {
	let output = [];
	current = flatest;
	for (let i=0; i<fifths; i++) {
		let obj= {};
		let pnum = current++;
		obj.pnum = pnum;
		obj.pname = numberToPitchName(pnum);
		if (pnum === center) {
			obj.center = 1;
		}
		output.push(obj);
	}
	return output;
}



//////////////////////////////
//
// numberToPitchName --
//

function numberToPitchName(number) {
	switch (number) {
		case -29: return "F𝄫𝄫";
		case -28: return "C𝄫𝄫";
		case -27: return "G𝄫𝄫";
		case -26: return "D𝄫𝄫";
		case -25: return "A𝄫𝄫";
		case -24: return "E𝄫𝄫";
		case -23: return "B𝄫𝄫";
		case -22: return "F𝄫♭";
		case -21: return "C𝄫♭";
		case -20: return "G𝄫♭";
		case -19: return "D𝄫♭";
		case -18: return "A𝄫♭";
		case -17: return "E𝄫♭";
		case -16: return "B𝄫♭";
		case -15: return "F𝄫";
		case -14: return "C𝄫";
		case -13: return "G𝄫";
		case -12: return "D𝄫";
		case -11: return "A𝄫";
		case -10: return "E𝄫";
		case -9: return "B𝄫";
		case -8: return "F♭";
		case -7: return "C♭";
		case -6: return "G♭";
		case -5: return "D♭";
		case -4: return "A♭";
		case -3: return "E♭";
		case -2: return "B♭";
		case -1: return "F";
		case 0: return "C";
		case 1: return "G";
		case 2: return "D";
		case 3: return "A";
		case 4: return "E";
		case 5: return "B";
		case 6: return "F♯";
		case 7: return "C♯";
		case 8: return "G♯";
		case 9: return "D♯";
		case 10: return "A♯";
		case 11: return "E♯";
		case 12: return "B♯";
		case 13: return "F𝄪";
		case 14: return "C𝄪";
		case 15: return "G𝄪";
		case 16: return "D𝄪";
		case 17: return "A𝄪";
		case 18: return "E𝄪";
		case 19: return "B𝄪";
		case 20: return "F𝄪♯";
		case 20: return "C𝄪♯";
		case 20: return "G𝄪♯";
		case 20: return "D𝄪♯";
		case 20: return "A𝄪♯";
		case 20: return "E𝄪♯";
		case 20: return "B𝄪♯";
		case 20: return "F𝄪𝄪";
		case 20: return "C𝄪𝄪";
		case 20: return "G𝄪𝄪";
		case 20: return "D𝄪𝄪";
		case 20: return "A𝄪𝄪";
		case 20: return "E𝄪𝄪";
		case 20: return "B𝄪𝄪";
	}
	return "X";
}



//////////////////////////////
//
// numberToPitchNameUtf7 --
//

function numberToPitchNameUtf7(number) {
	switch (number) {
		case -29: return "Fffff";
		case -28: return "Cffff";
		case -27: return "Gffff";
		case -26: return "Dffff";
		case -25: return "Affff";
		case -24: return "Effff";
		case -23: return "Bffff";
		case -22: return "Ffff";
		case -21: return "Cfff";
		case -20: return "Gfff";
		case -19: return "Dfff";
		case -18: return "Afff";
		case -17: return "Efff";
		case -16: return "Bfff";
		case -15: return "Fff";
		case -14: return "Cff";
		case -13: return "Gff";
		case -12: return "Dff";
		case -11: return "Aff";
		case -10: return "Eff";
		case -9: return "Bff";
		case -8: return "Ff";
		case -7: return "Cf";
		case -6: return "Gf";
		case -5: return "Df";
		case -4: return "Af";
		case -3: return "Ef";
		case -2: return "Bf";
		case -1: return "F";
		case 0: return "C";
		case 1: return "G";
		case 2: return "D";
		case 3: return "A";
		case 4: return "E";
		case 5: return "B";
		case 6: return "F#";
		case 7: return "C#";
		case 8: return "G#";
		case 9: return "D#";
		case 10: return "A#";
		case 11: return "E#";
		case 12: return "B#";
		case 13: return "F##";
		case 14: return "C##";
		case 15: return "G##";
		case 16: return "D##";
		case 17: return "A##";
		case 18: return "E##";
		case 19: return "B##";
		case 20: return "F###";
		case 20: return "C###";
		case 20: return "G###";
		case 20: return "D###";
		case 20: return "A###";
		case 20: return "E###";
		case 20: return "B###";
		case 20: return "F####";
		case 20: return "C####";
		case 20: return "G####";
		case 20: return "D####";
		case 20: return "A####";
		case 20: return "E####";
		case 20: return "B####";
	}
	return "X";
}


//////////////////////////////
//
// calculateCents --
//

function calculateCents() {
	let entries = document.querySelectorAll("table.fifthlist td:nth-child(2)");
	delement = document.querySelector("#decimal");
	let decimals = 3;
	if (delement) {
		decimals = parseInt(delement.value);
	}
	let commaS = 81/80;
	let commaP = Math.pow(3, 12) / Math.pow(2, 19);
	let commatype = "s"; // default comma is syntonic
	let comma = commaS;

	let centsum = 0;
	for (let i=0; i<entries.length - 1; i++) {
		let ielement = entries[i].querySelector("input");
		let celement = entries[i].querySelector(".cents");
		let factor = ielement.value;
		if (factor.match(/s/)) {
			comma = commaS;
		} else if (factor.match(/p/)) {
			comma = commaP;
		}
		factor = getFactorNumber(factor);
		let multiplier = Math.pow(comma, factor);
		let cents = Math.log2(1.5 * multiplier) * 1200;
		centsum += cents;
		let rcents = roundNumber(cents, decimals);
		celement.innerHTML = rcents + " cents";
		LIST[i].fifthup = cents;
	}
	let celement = entries[entries.length - 1].querySelector(".cents");
	let cvalue = entries.length * 700 - centsum;
	celement.innerHTML = roundNumber(cvalue, decimals) + " cents";
	createRatioscore();
	createGrid();
}


//////////////////////////////
//
// getFactorNumber --
//

function getFactorNumber(sval) {
	if (!sval) {
		return 0;
	}
	let matches = sval.match(/^\s*(-?\d+\.?\d*)\s*[ps]?\s*$/);
	if (matches) {
		return parseFloat(sval);
	}
	if (matches = sval.match(/^\s*(-?\d+)\/(\d+)\d*\s*[ps]?\s*$/)) {
		let top = parseInt(matches[1]);
		let bot = parseInt(matches[2]);
		return top/bot;
	}
	return 0;
}





//////////////////////////////
//
// roundNumber --
//

function roundNumber(number, decimals) {
	if (!decimals) {
		return parseInt(number);
	}
	let factor = Math.pow(10, decimals);
	let output;
	if (number >= 0) {
		output = parseInt(number * factor + 0.5) / factor;
	} else {
		output = -parseInt(-number * factor + 0.5) / factor;
	}
	return output;
}



//////////////////////////////
//
// createRatioscore --
//

function createRatioscore() {
	let element = document.querySelector("#tscore");
	let element2 = document.querySelector("#inputdata-tscore");
	if (!element) {
		return;
	}
	if (!element2) {
		return;
	}

	let center = -1;
	for (let i=0; i<LIST.length; i++) {
		if (LIST[i].center) {
			center = i;
			break;
		}
	}
	if (center < 0) {
		return;
	}
	
	LIST[center].cents = 0.0;

	let sum = 0;
	for (let i=center+1; i<LIST.length; i++) {
		sum += LIST[i-1].fifthup;
		if (sum >= 1200) {
			sum -= 1200;
		}
		LIST[i].cents = sum;
	}

	sum = 0;
	for (let i=center-1; i>=0; i--) {
		sum -= LIST[i].fifthup;
		if (sum <= 0) {
			sum += 1200;
		}
		if (sum <= 0) {
			sum += 1200;
		}
		LIST[i].cents = sum;
	}

	let chroma = [];
	for (let i=0; i<LIST.length; i++) {
		chroma.push(LIST[i]);
	}
	chroma.sort(function(a, b) {
		return a.cents - b.cents;
	});

	let decimals = 3;
	if (delement) {
		decimals = parseInt(delement.value);
	}

	let instrument = 8;
	let ielement = document.querySelector("#instrument");
	if (ielement) {
		instrument = ielement.value;
	}

	let output = "";
	output += "**ratio\t**ratio\t**ratio\n";
	output += "*I#" + instrument + "\t";
	output += "*I#" + instrument + "\t";
	output += "*I#" + instrument + "\n";
	output += "*MM120\t*MM120\t*MM120\n";
	output += "*ref:C4\t*ref:C4\t*ref:C4\n";
	for (let i=0; i<chroma.length; i++) {
		output += numberToPitchNameUtf7(chroma[i].pnum);
		output += "\t.\t.";
		output += "\n";
	}
	output += numberToPitchNameUtf7(chroma[0].pnum);
	output += "*2";
	output += "\t.\t.\n";

	let len = chroma.length;

	output += "*MM60\t*MM60\t*MM60\n";
	output += "!! Major triads:\n";
	for (let i=0; i<chroma.length; i++) {
		output += numberToPitchNameUtf7(chroma[i].pnum);
		output += "\t" + numberToPitchNameUtf7(chroma[(i+4)%len].pnum);
		output += getOctave(chroma, i, i+4);
		output += "\t " + numberToPitchNameUtf7(chroma[(i+7)%len].pnum);
		output += getOctave(chroma, i, i+7);
		output += "\n";
	}

	output += "!! Minor triads:\n";
	for (let i=0; i<chroma.length; i++) {
		output += numberToPitchNameUtf7(chroma[i].pnum);
		output += "\t" + numberToPitchNameUtf7(chroma[(i+3)%len].pnum);
		output += getOctave(chroma, i, i+3);
		output += "\t " + numberToPitchNameUtf7(chroma[(i+7)%len].pnum);
		output += getOctave(chroma, i, i+7);
		output += "\n";
	}

	output += "*-\t*-\t*-\n";

	for (let i=0; i<chroma.length; i++) {
		output += "!!!RDF**ratio: ";
		let name = numberToPitchNameUtf7(chroma[i].pnum);
		output += name;
		for (let i=name.length; i<5; i++) {
			output += " ";
		}
		output += " = ";
		value = roundNumber(chroma[i].cents, decimals);
		if (value == 0) {
			output += "   ";
			if (decimals > 0) {
				value += ".0";
			}
		} else if (value < 10) {
			output += "   ";
		} else if (value < 100) {
			output += "  ";
		} else if (value < 1000) {
			output += " ";
		}
		output += value + "c";
		output += "\n";
	}

	element.textContent = output;
	element2.textContent = output;
}



//////////////////////////////
//
// getOctave --
//

function getOctave(chroma, starti, endi) {
	if (endi >= chroma.length) {
		return "*2";
	}
	return "";
}



//////////////////////////////
//
// changeInstrument --
//

function changeInstrument() {
	element = document.querySelector("#instrument");
	if (!element) {
		return;
	}
	let instrument = element.value;

	let element = document.querySelector("#tscore");
	if (!element) {
		return;
	}
	let element2 = document.querySelector("#inputdata-tscore");
	if (!element2) {
		return;
	}

	let text = element.textContent;
	text = text.replace(/\*I[^\s]*/g, "*I#" + instrument);
	text = text.replace(/^\s*/, "");
	element.textContent = text;
	element2.textContent = text;
}



//////////////////////////////
//
// loadTemperament --
//
//	<option value="-3,0;(2);8">Pythagorean (D)</option>
//	<option value="-3,-1/4s;(2);8">1/4-comma (D)</option>
//

function loadTemperament(event) {
	let tstring = "";
	if (!event) {
		let element = document.querySelector("#temperament");
		if (element) {
			tstring = element.value;
		} else {
			tstring = "-3,0;(2);8";
		}
	} else if (typeof event === "string") {
		tstring = event;
	} else if (event.target) {
		// tstring = event.target.options[event.target.selectedIndex].value;
		tstring = event.target.value;
	}
	let pieces = tstring.split(/\s*;\s*/);
	let number;
	let list = [];
	let lastnum = "none";
	let lastcomma = 0;
	let lastcommaunit = "none";
	let comma = 0;
	let commaunit;
	let centerindex = "none";
	let center = 0;
	for (let i=0; i<pieces.length; i++) {
		console.log("PROCESSING ENTRY", pieces[i]);
		center = 0;
		if (pieces[i].match(/\(/)) {
			center = 1;
			pieces[i] = pieces[i].replace(/\(/g, "").replace(/\)/g, "");
		}

		let matches = pieces[i].match(/^\s*(-?\d+)/);
		let number = "none";

		if (matches) {
			number = parseInt(matches[1]);

			if (lastnum !== "none") {
				for (let j=lastnum + 1; j<number; j++) {
					let obj = {};
					obj.pnum = i;
					obj.comma = comma || 0;
					obj.commaunit = commaunit;
					list.push(obj);
				}
			}

			matches = pieces[i].match(/,\s*(-?\d+\/?\d*)\s*([sp]?)/);
			if (matches) {
				comma = matches[1] || 0;
				if (matches[2]) {
					commaunit = matches[2];
				}
			}

			let obj = {};
			obj.pnum = number;
			obj.comma = comma || 0;
			obj.commaunit = commaunit;
			if (center) {
				obj.center = 1;
				centerindex = i;
			}
			list.push(obj);
			lastnum = number;

		} else {
			console.log("ERROR in temperament entry:", pieces[i]);
			return;
		}

	}

	console.log("list", list);

	let felement = document.querySelector("#fifths");
	if (felement) {
		felement.value = list.length;
	}

	let telement = document.querySelector("#flatest");
	if (telement) {
		telement.value = list[0].pnum;
	}

	let celement = document.querySelector("#center");
	if (celement) {
		if (centerindex !== "none") {
			celement.value = list[centerindex].pnum;
		}
	}

	createTemperamentLayout();

	lastunit = "";
	let entries = document.querySelectorAll("table.fifthlist td:nth-child(2)");
	for (let i=0; i<entries.length; i++) {
		let ielement = entries[i].querySelector("input");
		let value = list[i].comma || 0;
		let unit = list[i].commaunit;
		if (!value) {
			unit = "";
		}
		if (!unit) {
			unit = "";
		}
		if (unit && (unit === lastunit)) {
			unit = "";
		} else {
			lastunit = unit;
		}
		ielement.value = value + unit;
	}

	calculateCents();
	createRatioscore();
}



//////////////////////////////
//
// buildTemperamentSelect --
//

function buildTemperamentSelect () {
	let select = document.querySelector("#temperament");
	if (!select) {
		return;
	}
	let output = "";
	let index = 0;
	for (let i=0; i<TEMPERAMENT.length; i++) {
		let entry = TEMPERAMENT[i];
		output += "<optgroup label='" + entry.NAME + "'>";
		let grouplist = entry.TEMPERAMENT;
		if (!Array.isArray(grouplist)) {
			grouplist = [ grouplist ];
		}
		for (let j=0; j<grouplist.length; j++) {
			output += "<option value='";
			output += grouplist[j].DEFINITION;
			output += "'>";
			output += grouplist[j].NAME;
			output += "</option>";
			let hash = grouplist[j].HASH;
			HASHINDEX[hash] = index++;
		}
		output += "</optgroup>";
	}
	select.innerHTML = output;
}



//////////////////////////////
//
// getAtonContent --
//

function getAtonContent(id) {
	let element = document.querySelector("#" + id);
	if (!element) {
		console.log("CANNOT FIND ELEMENT WITH ID =", id);
		return [];
	}
	let text = element.textContent;
	let aton = new ATON;
	return aton.parse(text);
}


//////////////////////////////
//
// createGrid --
//

function createGrid() {
	let gelement = document.querySelector("#grid");
	if (!gelement) {
		return;
	}

	let justintervals = [
		{interval: "9/8", name: "major-second", cents: Math.log2(9/8) * 1200},
		{interval: "8/7", name: "septimal-major-second", cents: Math.log2(8/7) * 1200},

		{interval: "5/4", name: "major-third", cents: Math.log2(5/4) * 1200},
		{interval: "6/5", name: "minor-third", cents: Math.log2(6/5) * 1200},
		{interval: "7/6", name: "septimal-minor-third", cents: Math.log2(7/6) * 1200},

		{interval: "3/2", name: "perfect-fifth", cents: Math.log2(3/2) * 1200},

		{interval: "4/3", name: "perfect-fourth", cents: Math.log2(4/3) * 1200},

		{interval: "5/3", name: "major-sixth", cents: Math.log2(5/3) * 1200},
		{interval: "12/7", name: "septimal-major-sixth", cents: Math.log2(12/7) * 1200},
		{interval: "8/5", name: "minor-sixth", cents: Math.log2(8/5) * 1200},
		{interval: "14/9", name: "septimal-minor-sixth", cents: Math.log2(14/9) * 1200},
		{interval: "11/7", name: "undecimal-minor-sixth", cents: Math.log2(11/7) * 1200},

		{interval: "7/4", name: "septimal-minor-seventh", cents: Math.log2(7/4) * 1200}
	]

	delement = document.querySelector("#decimal");
	let decimals = 3;
	if (delement) {
		decimals = parseInt(delement.value);
	}

	let output  = "<h2>Temperament grid</h2> ";
	output += "<table class='grid'>";
	output += "<tr><th></th>";
	for (let i=0; i<LIST.length; i++) {
		output += "<th>";
		output += LIST[i].pname;
		output += "</th>";
	}
	output += "</tr>";


	for (let i=0; i<LIST.length; i++) {
		output += "<tr>";
		output += "<th>";
		output += LIST[i].pname;
		output += "</th>";
		for (let j=0; j<LIST.length; j++) {
			let cents = LIST[j].cents - LIST[i].cents;
			if (cents < 0) {
				cents += 1200;
			}
			let iclass = getIntervalIndex(cents, justintervals);
			if (iclass >= 0) {
				let nclass = justintervals[iclass].name;
				let tclass = justintervals[iclass].interval;
				tclass += ": " + nclass.replace(/-/g, " ")
				output += "<td class='grid " + nclass + "' ";
				output += "title='" + tclass + "'";
				output += ">";
			} else {
				output += "<td class='grid'>";
			}
			let rcents = roundNumber(cents, decimals);
			output += rcents;
			output += "</td>";
		}
		output += "</tr>";
	}

	output += "</table>";
	gelement.innerHTML = output;
}


///////////////////////////////
//
// getIntervalIndex --
//

function getIntervalIndex(cents, justintervals, tolerance) {
	if (!tolerance) {
		tolerance = 1;
	}
	for (let i=0; i<justintervals.length; i++) {
		let difference = Math.abs(cents - justintervals[i].cents);
		if (difference < tolerance) {
			return i;
		}
	}
	return -1;
}


</script>



