

<script>
// vim: ts=3



//////////////////////////////
//
// makeUrl --
//

function makeUrl() {
	let url = window.location.href.replace(/\?.*/, "");
	let oelement = document.querySelector("#octave");
	let delement = document.querySelector("#divisions");
	let telement = document.querySelector("#tempo");
	let relement = document.querySelector("#reference");
	let ielement = document.querySelector("#instrument");

	url += "?";
	let initialized = 0;

	if (oelement) {
		if (initialized) { url += "&"; }
		url += "o=" + encodeURIComponent(oelement.value);
		initialized = 1;
	}

	if (delement) {
		if (initialized) { url += "&"; }
		url += "d=" + encodeURIComponent(delement.value);
		initialized = 1;
	}

	if (telement) {
		if (initialized) { url += "&"; }
		url += "t=" + encodeURIComponent(telement.value);
		initialized = 1;
	}

	if (relement) {
		if (initialized) { url += "&"; }
		url += "r=" + encodeURIComponent(relement.value);
		initialized = 1;
	}

	if (ielement) {
		if (initialized) { url += "&"; }
		url += "i=" + encodeURIComponent(ielement.value);
		initialized = 1;
	}

	return url;
}



//////////////////////////////
//
// copyUrl --
//

function copyUrl() {
	let url = makeUrl();
	copyToClipboard(url);
}



//////////////////////////////
//
// copyToClipboard --
//

function copyToClipboard(string) {
	// console.log("Copying", string, "to clipboard");
	var element = document.createElement("textarea");
	element.value = string;
	document.body.appendChild(element);
	element.select();
	document.execCommand("copy");
	document.body.removeChild(element);
};



//////////////////////////////
//
// getCGIparameters -- Returns an associative array containing the
//     page's URL's CGI parameters
//

function getCGIparameters() {
	var url = window.location.search.substring(1);
	var output = {};
	var settings = url.split('&');
	if ((settings.length == 1) && (settings[0] === "")) {
		return {};
	}
	for (var i=0; i<settings.length; i++) {
		var pair = settings[i].split('=');
		pair[0] = decodeURIComponent(pair[0]);
		pair[1] = decodeURIComponent(pair[1]);
		if (typeof output[pair[0]] === 'undefined') {
			output[pair[0]] = pair[1];
		} else if (typeof output[pair[0]] === 'string') {
			var arr = [ output[pair[0]], pair[1] ];
			output[pair[0]] = arr;
		} else {
			output[pair[0]].push(pair[1]);
		}
	}
	console.log(output);
	return output;
}


//////////////////////////////
//
// calculateEQscore -- Prepare an Equal-temperament score based on input parameters.
//

function calculateEQscore () {
	let oelement = document.querySelector("#octave");
	if (!oelement) {
		console.log("Error: #octave not found");
		return;
	}

	let delement = document.querySelector("#divisions");
	if (!delement) {
		console.log("Error: #divisions not found");
		return;
	}

	let dtext = delement.value;
	let matches = dtext.match(/^([1-9][0-9]*)/);
	if (!matches) {
		return;
	}
	let dnum = parseInt(matches[1]);
	if (dnum < 2) {
		return;
	}
	if (dnum > 5000) {
		return;
	}

	let onum = 0;
	let top = 0;
	let bot = 0;
	let otext = oelement.value;
	matches = otext.match(/^([1-9][0-9]*)\/([1-9][0-9]*)/);
	if (!matches) {
		// integer onum
		matches = otext.match(/^([1-9][0-9]*)/);
		if (!matches) {
			return;
		} else {
			onum = parseInt(matches[1]);
			if (onum < 2) {
				return;
			}
		}

	} else {
		// fractional onum
		top = parseInt(matches[1]);
		bot = parseInt(matches[2]);
		if ((top == 1) && (bot == 1)) {
			return;
		}
		onum = parseFloat(top) / parseFloat(bot);
	}

	let tempo = "*";
	let telem = document.querySelector("#tempo");
	if (telem) {
		let ttext = telem.value;
		matches = ttext.match(/([1-9][0-9]+\.?[0-9]*)/);
		if (matches) {
			tempo = "*MM" + matches[1];
		}
	}

	let reference = "C4";
	let relem = document.querySelector("#reference");
	if (relem) {
		let rtext = relem.value;
		matches = rtext.match(/^([A-G][0-9])/);
		if (matches) {
			reference = matches[1];
		}
	}

	let instrument = "clars";
	let ielem = document.querySelector("#instrument");
	if (ielem) {
		instrument = ielem.value;
	}
	if (instrument.match(/^\d/)) {
		instrument = "#" + instrument;
	}

	let outelem1 = document.querySelector("#etscore");
	let outelem2 = document.querySelector("#inputdata-etscore");
	if (!outelem1) {
		console.log("Error: No script area 1");
		return;
	}
	if (!outelem2) {
		console.log("Error: No script area 2");
		return;
	}
	
	// let output = "!!!octave: " + onum + "\n";
	// if (top > 0) {
	// 	output = "!!!octave: " + top + "/" + bot + "\n";
   // }
	// output += "!!!divisions: " + dnum + "\n";

	let output = "";
	output += "**dtime\t**ratio\t**cents\n";
	output += tempo + "\t*I" + instrument + "\t*I" + instrument + "\n";
	output += "*\t*ref:" + reference + "\t*ref:" + reference + "\n";
	let octavecents = 0;
	if (top > 0) {
		octavecents = 1200 * Math.log2(top/bot);
	} else {
		octavecents = 1200 * Math.log2(onum);
	}
	for (let i=0; i<=dnum; i++) {
		let cents = octavecents / dnum * i;
		cents = parseInt(cents * 100.0 + 0.5) / 100.0;
		if (top > 0) {
			output += "1\t(" + top + "/" + bot + ")^(" + i + "/" + dnum + ")\t" + cents + "\n";
		} else {
			output += "1\t" + onum + "^(" + i + "/" + dnum + ")\t" + cents + "\n";
		}
	}
	output += "*-\t*-\t*-\n";
	output += "!!!URL: " + makeUrl() + "\n";

	outelem1.textContent = output;
	outelem2.textContent = output;
}



</script>
