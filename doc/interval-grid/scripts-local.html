
<script>
// vim: ts=3:ft=javascript

{% include_relative RationalNumber-base.js %}
{% include_relative RationalNumber-math.js %}


let AUDIOcache = {};
let AUDIOsequence = [];
let AUDIOseqname  = [];

//////////////////////////////
//
// loadDefaultSettings --
//

function loadDefaultSettings() {
	SETTINGS = JSON.parse(JSON.stringify(DEFAULTS));
}



//////////////////////////////
//
// loadCgiSettings --
//

function loadCgiSettings() {
	let plist = getParameterList(DEFAULTS);
	let cgi = GetCgiParameters();
	for (let i=0; i<plist.length; i++) {
		let key = plist[i];
		if (typeof cgi[plist[i]] === "undefined") {
			continue;
		}
		SETTINGS[key] = cgi[key];
	}
}



//////////////////////////////
//
// updateInputsFromSettings --
//

function updateInputsFromSettings() {
	let inputs = document.querySelectorAll("input");
	for (let i=0; i<inputs.length; i++) {
		let id = inputs[i].id;
		if (typeof SETTINGS[id] !== "undefined") {
			inputs[i].value = SETTINGS[id];
		}
	}

	let selects = document.querySelectorAll("select");
	for (let i=0; i<selects.length; i++) {
		let id = selects[i].id;
		if (typeof SETTINGS[id] !== "undefined") {
			setSelectedIndex(selects[i], SETTINGS[id]);
		}
	}
}



////////////////////
//
// setSelectedIndex --
//

function setSelectedIndex(select, value) {
	for (let i=0; i<select.options.length; i++) {
		if (select.options[i].value == value) {
			select.options[i].selected = true;
			return;
		}
	}
}



//////////////////////////////
//
// getParameterValue --
//

function getParameterValue(parameter) {
	return SETTINGS[parameter];
}



//////////////////////////////
//
// getParameterList --
//

function getParameterList(obj) {
	if (!obj) {
		return [];
	}
	let output = Object.getOwnPropertyNames(obj);
	return output;
}



//////////////////////////////
//
// makeUrl --
//

function makeUrl() {
	let params = getParameterList(DEFAULTS);
	let outlist = [];
	// Store any parameters in SETTINGS that are not the same as DEFAULTS:
	for (let i=0; i<params.length; i++) {
		let key = params[i];
		if (DEFAULTS[key] == SETTINGS[key]) {
			continue;
		}
		let value = SETTINGS[key];
		let entry = key + "=" + encodeURIComponent(value);
		outlist.push(entry);
	}
	if (outlist.length == 0) {
		return "";
	}

	let url = window.location.href.replace(/\?.*/, "");
	if (outlist.length > 0) {
		url += "?" + outlist[0];
	}
	for (let i=1; i<outlist.length; i++) {
		url += "&" + outlist[i];
	}
	return url;
}



//////////////////////////////
//
// generateGrid --
//

function generateGrid() {
	updateSettingsFromInput();
	let target = document.querySelector("#grid");
	if (!target) {
		return;
	}

	let rows = SETTINGS.rows;
	let columns = SETTINGS.columns;

	let intervals = {};

	let output = "";
	output += "<table>";
	for (let r=1; r<=rows; r++) {
		output += "<tr>";
		for (let c=1; c<=columns; c++) {
			let reduced = getInterval(c, r, true);
			intervals[reduced] = 1;
			let midikey = calculateMidiKey(reduced, SETTINGS.reference);
			if ((midikey < 110) && (midikey > 9)) {
				output += "<td class='playinterval'>";
			} else {
				output += "<td class='invalid'>";
			}
			output += getInterval(c, r, SETTINGS.reduce);
			output += "</td>";
		}
		output += "</tr>";
	}
	output += "</table>";

	output += sortedList(intervals);

	grid.innerHTML = output;
}



//////////////////////////////
//
// calculateMidiKey --
//

function calculateMidiKey(interval, reference) {
	let matches = reference.match(/^([A-G])(#)?(\d+)/);
	if (!matches) {
		return 60;
	}
	let pc         = matches[1];
	let accidental = matches[2];
	let octave     = matches[3];
	let midiref;
	if (pc === "C") {
		midiref = 0;
	} else if (pc === "D") {
		midiref = 2;
	} else if (pc === "E") {
		midiref = 4;
	} else if (pc === "F") {
		midiref = 5;
	} else if (pc === "G") {
		midiref = 7;
	} else if (pc === "A") {
		midiref = 9;
	} else if (pc === "B") {
		midiref = 11;
	} else {
		midiref = 0;
	}
	if (matches[2]) {
		midiref++;
	}
	midiref += 12 * (parseInt(octave) + 1);
	matches = interval.match(/^\s*(\d+)\/(\d+)\s*$/);
	let adjustment = 0;
	if (matches) {
		let top = matches[1];
		let bot = matches[2];
		adjustment = 12 * Math.log2(parseFloat(top)/parseFloat(bot));
	} else {
		matches = interval.match(/^\s*(\d+)\s*$/);
		if (matches) {
			adjustment = 12.0 * Math.log2(parseFloat(matches[1]));
		} else {
			adjustment = 0;
		}
	}
	let midinote = midiref + adjustment;
	return midinote;
}



//////////////////////////////
//
// calculateMidiKeyCents --
//

function calculateMidiKeyCents(cents, reference, dontround) {
	let matches = reference.match(/^([A-G])(#)?(\d+)/);
	if (!matches) {
		return 60;
	}
	let pc         = matches[1];
	let accidental = matches[2];
	let octave     = matches[3];
	let midiref;
	if (pc === "C") {
		midiref = 0;
	} else if (pc === "D") {
		midiref = 2;
	} else if (pc === "E") {
		midiref = 4;
	} else if (pc === "F") {
		midiref = 5;
	} else if (pc === "G") {
		midiref = 7;
	} else if (pc === "A") {
		midiref = 9;
	} else if (pc === "B") {
		midiref = 11;
	} else {
		midiref = 0;
	}
	if (matches[2]) {
		midiref++;
	}
	midiref += 12 * (parseInt(octave) + 1);

	let midinote = midiref + cents/ 100.0;
	// Round to 3 digits:
	if (!dontround) {
		midinote = parseInt(midinote * 1000.0 + 0.5) / 1000.0;
		midinote = "" + midinote;
		if (!midinote.match(/\./)) {
			midinote += ".000";
		} else if (midinote.match(/\.\d$/)) {
			midinote += "00";
		} else if (midinote.match(/\.\d\d$/)) {
			midinote += "0";
		}
	}

	return midinote;
}



//////////////////////////////
//
// sortedList --
//

function sortedList(intervals) {
	let keys = Object.keys(intervals);
	let newlist = {};
	for (let i=0; i<keys.length; i++) {
		let obj = {};
		obj.interval = keys[i];
		obj.cents = calculateCents(keys[i]);
		obj.midikey = calculateMidiKeyCents(obj.cents, SETTINGS.reference);
		obj.freq = interval2hz(keys[i], SETTINGS.reference);
		newlist[obj.cents] = obj;
	}
	let centkeys = Object.keys(newlist);

	centkeys.sort(function(a, b) { return b - a; });

	let negative = "";
	negative += "<table class='sortedlist'>\n";
	negative += "<tr><th>Ratio</th><th></th><th>Cents</th><th></th><th>MIDI&nbsp;key</th><th></th><th>Hz</th></tr>\n";
	for (let i=0; i<centkeys.length; i++) {
		let cents    = newlist[centkeys[i]].cents;
		let interval = newlist[centkeys[i]].interval;
		let midikey  = newlist[centkeys[i]].midikey;
		let freq     = newlist[centkeys[i]].freq;
		if ((cents < 0.0) && (midikey > 9) && (midikey < 110)) {
			negative += "<tr>";
			negative += "<td class='playinterval'>";
			negative += interval;
			negative += "</td>";
			negative += "<td>&mdash;";
			negative += "</td>";
			negative += "<td class='playcents'>";
			negative += cents;
			negative += "</td>";
			negative += "<td>&mdash;";
			negative += "</td>";
			negative += "<td class='playmidikey'>";
			negative += midikey;
			negative += "</td>";
			negative += "<td>&mdash;";
			negative += "</td>";
			negative += "<td class='playhz'>";
			negative += freq;
			negative += "</td>";
			negative += "</tr>\n";
		}
	}
	negative += "</table>\n";

	centkeys.sort(function(a, b) { return a - b; });

	let positive = "";
	positive += "<table class='sortedlist'>\n";
	positive += "<tr><th>Ratio</th><th></th><th>Cents</th><th></th><th>MIDI&nbsp;key</th><th></th><th>Hz</th></tr>\n";
	for (let i=0; i<centkeys.length; i++) {
		let cents    = newlist[centkeys[i]].cents;
		let interval = newlist[centkeys[i]].interval;
		let midikey  = newlist[centkeys[i]].midikey;
		let freq     = newlist[centkeys[i]].freq;
		if ((cents > 0.0) && (midikey > 9) && (midikey < 110)) {
			positive += "<tr>";
			positive += "<td class='playinterval'>";
			positive += interval;
			positive += "</td>";
			positive += "<td>&mdash;";
			positive += "</td>";
			positive += "<td class='playcents'>";
			positive += cents;
			positive += "</td>";
			positive += "<td>&mdash;";
			positive += "</td>";
			positive += "<td class='playmidikey'>";
			positive += midikey;
			positive += "</td>";
			positive += "<td>&mdash;";
			positive += "</td>";
			positive += "<td class='playhz'>";
			positive += freq;
			positive += "</td>";
			positive += "</tr>\n";
		}
	}
	positive += "</table>\n";

	let output = "";
	output += "<table class='plusminus'>";
	output += "<tr>";

	output += "<td>";
	output += positive;
	output += "</td>";

	output += "<td>";
	output += "</td>";

	output += "<td>";
	output += negative;
	output += "</td>";

	output += "</tr>";
	output += "</table>";

	return output;
}


//////////////////////////////
//
// midi2hz -- not used anymore because midikey is already rounded.
//

function midi2hz(midikey) {
	let value = 440.0 * Math.pow(2, (parseFloat(midikey) - 69)/12);
	return value;
}



//////////////////////////////
//
// interval2hz --
//

function interval2hz(interval, reference) {
	let midinote = calculateMidiKey(interval, reference);
	let cents = 100 * (midinote - 69.0);
	let freq = 440.0 * Math.pow(2, cents / 1200.0);
	freq = parseInt(freq * 100.0 + 0.5) / 100.0;
	freq = "" + freq;
	if (!freq.match(/\./)) {
		freq += ".00";
	} else if (freq.match(/\.\d$/)) {
		freq += "0";
	}
	return freq;
}



//////////////////////////////
//
// calculateCents --
//

function calculateCents(ratio) {

	let matches;
	let value = 0;
	matches = ratio.match(/^\s*(\d+)\s*\/\s*(\d+)\s*$/);
	if (matches) {
		let top = parseFloat(matches[1]);
		let bot = parseFloat(matches[2]);
		value = top / bot;
	} else {
		matches = ratio.match(/^\s*(\d+)/);
		if (matches) {
			value = parseInt(matches[1]);
		} else {
			value = 0;
		}
	}
	if (value <= 0.0) {
		return "error";
	}

	let cents = Math.log2(value) * 1200.0;
	if (cents < 0.0) {
		cents = -parseInt(-cents * 100.0 + 0.5) / 100.0;
	} else {
		cents = parseInt(cents * 100.0 + 0.5) / 100.0;
	}
	cents = "" + cents;
	if (!cents.match(/\./)) {
		cents = cents + ".00";
	} else if (cents.match(/\.\d$/)) {
		cents = cents + "0";
	}
	return cents;

}



//////////////////////////////
//
// playCents --
//

function playCents(event) {
	// console.log("PLAYAING CENTS", event);
	let cents;
	if (typeof event === "string") {
		cents = event;
	} else {
		let target = event.target;
		cents = target.textContent;
	}
	let ratioscore = createRatioscoreCents(cents);
	if (AUDIOcache[ratioscore]) {
		AUDIOsequence.push(ratioscore);
		AUDIOseqname.push(cents + " cents");
		AUDIOratioscore = ratioscore;
		AUDIOurl = AUDIOcache[ratioscore];
		playMp3();
		return;
	}
	let formdata = new FormData();
	formdata.append("inputdata", ratioscore);
	formdata.append("outputformat", "mp3");
	let request = new XMLHttpRequest();
	request.open("POST", "https://data.ratioscore.humdrum.org");
	request.responseType = "blob";
	request.onload = function () {
		let myblob = this.response;
		let audiourl = window.URL.createObjectURL(myblob);
		AUDIOcache[ratioscore] = audiourl;
		AUDIOsequence.push(ratioscore);
		AUDIOseqname.push(cents + " cents");
		AUDIOratioscore = ratioscore;
		AUDIOurl = audiourl;
		playMp3();
	};
	request.send(formdata);
}



//////////////////////////////
//
// playHz --
//

function playHz(event) {
	console.log("PLAYING HERE  HZ", event);
	let freq;
	if (typeof event === "string") {
		freq = event;
	} else {
		let target = event.target;
		freq = target.textContent;
	}
	let ratioscore = createRatioscoreHertz(freq);
	if (AUDIOcache[ratioscore]) {
		AUDIOsequence.push(ratioscore);
		AUDIOseqname.push(freq + " Hz");
		AUDIOratioscore = ratioscore;
		AUDIOurl = AUDIOcache[ratioscore];
		playMp3();
		return;
	}
	let formdata = new FormData();
	formdata.append("inputdata", ratioscore);
	formdata.append("outputformat", "mp3");
	let request = new XMLHttpRequest();
	request.open("POST", "https://data.ratioscore.humdrum.org");
	request.responseType = "blob";
	request.onload = function () {
		let myblob = this.response;
		let audiourl = window.URL.createObjectURL(myblob);
		AUDIOcache[ratioscore] = audiourl;
		AUDIOsequence.push(ratioscore);
		AUDIOseqname.push(freq + " Hz");
		AUDIOratioscore = ratioscore;
		AUDIOurl = audiourl;
		playMp3();
	};
	request.send(formdata);
}



//////////////////////////////
//
// playMidiKey --
//

function playMidiKey(event) {
	let midikey;
	if (typeof event === "string") {
		midikey = event;
	} else {
		let target = event.target;
		midikey = target.textContent;
	}
	let ratioscore = createRatioscoreMidiKey(midikey);
	if (AUDIOcache[ratioscore]) {
		AUDIOsequence.push(ratioscore);
		AUDIOseqname.push(midikey + " MIDI");
		AUDIOratioscore = ratioscore;
		AUDIOurl = AUDIOcache[ratioscore];
		playMp3();
		return;
	}
	let formdata = new FormData();
	formdata.append("inputdata", ratioscore);
	formdata.append("outputformat", "mp3");
	let request = new XMLHttpRequest();
	request.open("POST", "https://data.ratioscore.humdrum.org");
	request.responseType = "blob";
	request.onload = function () {
		let myblob = this.response;
		let audiourl = window.URL.createObjectURL(myblob);
		AUDIOcache[ratioscore] = audiourl;
		AUDIOsequence.push(ratioscore);
		AUDIOseqname.push(midikey + " MIDI");
		AUDIOratioscore = ratioscore;
		AUDIOurl = audiourl;
		playMp3();
	};
	request.send(formdata);
}



//////////////////////////////
//
// playInterval --
//

function playInterval(event) {
	// console.log("PLAYING INTERVAL", event);
	let interval;
	if (typeof event === "string") {
		interval = event;
	} else {
		let target = event.target;
		interval = target.textContent;
	}
	let ratioscore = createRatioscore(interval);
	if (AUDIOcache[ratioscore]) {
		AUDIOsequence.push(ratioscore);
		AUDIOseqname.push(interval);
		AUDIOratioscore = ratioscore;
		AUDIOurl = AUDIOcache[ratioscore];
		playMp3();
		return;
	}

	// console.log("RATIOSCORE", ratioscore);
	let formdata = new FormData();
	formdata.append("inputdata", ratioscore);
	formdata.append("outputformat", "mp3");
	let request = new XMLHttpRequest();
	request.open("POST", "https://data.ratioscore.humdrum.org");
	request.responseType = "blob";
	request.onload = function () {
		let myblob = this.response;
		let audiourl = window.URL.createObjectURL(myblob);
		AUDIOcache[ratioscore] = audiourl;
		AUDIOsequence.push(ratioscore);
		AUDIOseqname.push(interval);
		AUDIOratioscore = ratioscore;
		AUDIOurl = audiourl;
		playMp3();
	};
	request.send(formdata);

}



//////////////////////////////
//
// createRatioscore --
//

function createRatioscore(interval) {
	let reference = "*ref:" + SETTINGS.reference;
	let instrument = SETTINGS.instrument;
	if (instrument.match(/^\d/)) {
		instrument = "*I#" + instrument;
	} else {
		instrument = "*I" + instrument;
	}
	let refsound = "1";
	if (!SETTINGS.playref) {
		refsound = "0";
	}
	let output = "";
	output += "**dtime\t**ratio\t**ratio\n";
	output += "*MM60\t" + instrument + "\t" + instrument + "\n";
	output += "*\t" + reference + "\t" + reference + "\n";
	output += "1\t" + interval + "\t" + refsound + "\n";
	output += "*-\t*-\t*-\n";
	return output;
}



//////////////////////////////
//
// createRatioscoreCents --
//

function createRatioscoreCents(cents) {
	let reference = "*ref:" + SETTINGS.reference;
	let instrument = SETTINGS.instrument;
	if (instrument.match(/^\d/)) {
		instrument = "*I#" + instrument;
	} else {
		instrument = "*I" + instrument;
	}
	let refsound = "1";
	if (!SETTINGS.playref) {
		refsound = "0";
	}
	let output = "";
	output += "**dtime\t**ratio\t**ratio\n";
	output += "*MM60\t" + instrument + "\t" + instrument + "\n";
	output += "*\t" + reference + "\t" + reference + "\n";
	output += "1\t" + cents + "c\t" + refsound + "\n";
	output += "*-\t*-\t*-\n";
	return output;
}



//////////////////////////////
//
// createRatioscoreHertz --
//

function createRatioscoreHertz(freq) {
	let instrument = SETTINGS.instrument;
	if (instrument.match(/^\d/)) {
		instrument = "*I#" + instrument;
	} else {
		instrument = "*I" + instrument;
	}
	let refsound = "1";
	if (!SETTINGS.playref) {
		refsound = "0";
	}
	let output = "";
	let reference = "*ref:" + SETTINGS.reference;
	output += "**dtime\t**ratio\t**ratio\n";
	output += "*MM60\t" + instrument + "\t" + instrument + "\n";
	output += "*\t" + "*" + "\t" + reference + "\n";
	output += "1\t" + freq + "z\t" + refsound + "\n";
	output += "*-\t*-\t*-\n";
	return output;
}




//////////////////////////////
//
// createRatioscoreMidiKey --
//

function createRatioscoreMidiKey(midikey) {
	let instrument = SETTINGS.instrument;
	if (instrument.match(/^\d/)) {
		instrument = "*I#" + instrument;
	} else {
		instrument = "*I" + instrument;
	}
	let refsound = "1";
	if (!SETTINGS.playref) {
		refsound = "0";
	}
	let reference = "*ref:" + SETTINGS.reference;
	let output = "";
	output += "**dtime\t**ratio\t**ratio\n";
	output += "*MM60\t" + instrument + "\t" + instrument + "\n";
	output += "*\t" + "*" + "\t" + reference + "\n";
	output += "1\t" + midikey + "m\t" + refsound + "\n";
	output += "*-\t*-\t*-\n";
	return output;
}



//////////////////////////////
//
// getInterval --
//

function getInterval(top, bot, reduce) {
	if (reduce) {
		let value = new RationalNumber(top, bot);
		return value.toString();
	} else {
		return top + "/" + bot;
	}
}



//////////////////////////////
//
// updateSettingsFromInput --
//

function updateSettingsFromInput() {
	let inputs = document.querySelectorAll("input");
	for (let i=0; i<inputs.length; i++) {
		let id = inputs[i].id;
		if (typeof SETTINGS[id] !== "undefined") {
			if (inputs[i].type === "checkbox") {
				if (inputs[i].checked) {
					SETTINGS[id] = 1;
				} else {
					SETTINGS[id] = 0;
				}
			} else {
				SETTINGS[id] = inputs[i].value;
			}
		}
	}

	let selects = document.querySelectorAll("select");
	for (let i=0; i<selects.length; i++) {
		let id = selects[i].id;
		if (typeof SETTINGS[id] !== "undefined") {
			SETTINGS[id] = selects[i].value;
		}
	}
}



///////////////////////////////
//
// playMp3Url --
//

function playMp3Url(url) {
	if (!AUDIO) {
	   AUDIO = document.getElementById('audio');
  	}
	if (!AUDIO) {
		AUDIO = document.createElement("AUDIO");
		AUDIO.id = "audio";
		document.body.appendChild(AUDIO);
	}
   if (!AUDIO) {
		console.log('Error: could not set up audio interface\n');
		return false;
   }

	AUDIO.style.display = "none";
	var source = AUDIO.querySelector("source");
	if (!source) {
		source = document.createElement("SOURCE");
		AUDIO.appendChild(source);
	}

	source.src = url;
	AUDIO.load();
	AUDIO.currentTime = 0;
	AUDIO.play();

}



//////////////////////////////
//
// playAudioUrl --
//

function playMp3() {
	if (!AUDIO) {
	   AUDIO = document.getElementById('audio');
  	}
	if (!AUDIO) {
		AUDIO = document.createElement("AUDIO");
		AUDIO.id = "audio";
		document.body.appendChild(AUDIO);
	}
   if (!AUDIO) {
		console.log('Error: could not set up audio interface\n');
		return false;
   }

	//AUDIO.setAttribute('controls', 'controls');
	//AUDIO.style.position = 'fixed';
	//AUDIO.style.bottom = '0';
	//AUDIO.style.right = '0';
	//AUDIO.style.zIndex = '1';
	// AUDIO.onpause = function () { }

	AUDIO.style.display = "none";
	var source = AUDIO.querySelector("source");
	if (!source) {
		source = document.createElement("SOURCE");
		AUDIO.appendChild(source);
	}
	source.src = AUDIOurl;
	AUDIO.load();
	AUDIO.currentTime = 0;
	AUDIO.play();
}



</script>



