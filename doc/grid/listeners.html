
<script>
// vim: ts=3:ft=javascript

let AUDIOcache       = {};
let AUDIOsequence    = [];
let AUDIOseqname     = [];
let AUDIOratiolist   = [];

let DEFAULTS = {
	"rows": 10,
	"columns": 10,
	"reference": "C4",
	"playref": 1,
	"instrument": 71,
	"duration": 2,
	"reduce": 0
};

let SETTINGS = {};

let SEQUENCE = {};

SEQUENCE["1"] = 0;
SEQUENCE["2"] = 1;
SEQUENCE["3"] = 2;
SEQUENCE["4"] = 3;
SEQUENCE["5"] = 4;
SEQUENCE["6"] = 5;
SEQUENCE["7"] = 6;
SEQUENCE["8"] = 7;
SEQUENCE["9"] = 8;
SEQUENCE["0"] = 9;
SEQUENCE["-"] = 10;
SEQUENCE["="] = 11;
SEQUENCE["q"] = 12;
SEQUENCE["w"] = 13;
SEQUENCE["e"] = 14;
SEQUENCE["r"] = 15;
SEQUENCE["t"] = 16;
SEQUENCE["y"] = 17;
SEQUENCE["u"] = 18;
SEQUENCE["i"] = 19;
SEQUENCE["o"] = 20;
SEQUENCE["p"] = 21;
SEQUENCE["["] = 22;
SEQUENCE["]"] = 23;
SEQUENCE["\\"] = 24;
SEQUENCE["a"] = 25;
SEQUENCE["s"] = 26;
SEQUENCE["d"] = 27;
SEQUENCE["f"] = 28;
SEQUENCE["g"] = 29;
SEQUENCE["h"] = 30;
SEQUENCE["j"] = 31;
SEQUENCE["k"] = 32;
SEQUENCE["l"] = 33;
SEQUENCE[";"] = 34;
SEQUENCE["'"] = 35;
SEQUENCE["z"] = 36;
SEQUENCE["x"] = 37;
SEQUENCE["c"] = 38;
SEQUENCE["v"] = 39;
SEQUENCE["b"] = 40;
SEQUENCE["n"] = 41;
SEQUENCE["m"] = 42;
SEQUENCE[","] = 43;
SEQUENCE["."] = 44;
SEQUENCE["/"] = 45;


document.addEventListener("DOMContentLoaded", function () {
	loadDefaultSettings();
	loadCgiSettings();

	let inputs = document.querySelectorAll("input");
	for (let i=0; i<inputs.length; i++) {
		if (inputs[i].type === "checkbox") {
			inputs[i].addEventListener("click", generateGrid);
		} else {
			inputs[i].addEventListener("keyup", generateGrid);
		}
	}

	let selects = document.querySelectorAll("select");
	for (let i=0; i<selects.length; i++) {
		selects[i].addEventListener("change", generateGrid);
	}

	updateInputsFromSettings();
	generateGrid();
});


//////////////////////////////
//
// play event delegator --
//

document.addEventListener("click", function (event) {
	let target = event.target;
	let interval = "XXX";
	let cents = "XXX";
	let freq = "XXX";
	let midikey = "XXX";

	while (target) {
		if (target.nodeName === "BODY") {
			break;
		}
		if (target.nodeName !== "TD") {
			target = target.parentNode;
			continue;
		}
		if (target.classList.contains("playinterval")) {
			interval = target.textContent;
			break;
		}
		if (target.classList.contains("playcents")) {
			cents = target.textContent;
			break;
		}
		if (target.classList.contains("playhz")) {
			freq = target.textContent;
			break;
		}
		if (target.classList.contains("playmidikey")) {
			midikey = target.textContent;
			break;
		}
		target = target.parentNode;
	}

	if ((interval === cents) && (interval === midikey) && (interval === freq)) {
		return;
	}
	if (interval !== "XXX") {
		playInterval(interval);
	} else if (cents !== "XXX") {
		playCents(cents);
	} else if (freq !== "XXX") {
		playHz(freq);
	} else if (midikey !== "XXX") {
		playMidiKey(midikey);
	}
});



//////////////////////////////
//
// keypress event handlers --
//

document.addEventListener("keydown", function (event) {
	// console.log("KEY", event.key);
	let target = event.target;
	if (target.nodeName === "INPUT") {
		return;
	}
	if (event.metaKey) {
		return;
	}
	if (event.key === "Meta") {
		return;
	}

	if (event.key === "Backspace") {
		// Clear mapping sounds to computer keys.
		AUDIOsequence = [];
		AUDIOseqname = [];
		AUDIOratiolist = [];
		printNoteMapping();
		var notename = document.querySelector("#notename");
		if (notename) {
			notename.innerHTML = "";
		}
		var ratiotext = document.querySelector("#ratioscore");
		if (ratiotext) {
			ratiotext.innerHTML = "";
			relement.style.display = "none";
		}
		event.preventDefault();
		return;
	}

	if (AUDIOsequence[SEQUENCE[event.key]]) {
		playMp3Url(AUDIOcache[AUDIOsequence[SEQUENCE[event.key]]]);
		let interval = AUDIOseqname[SEQUENCE[event.key]];
		let rscore = AUDIOratiolist[SEQUENCE[event.key]];

		let nelement = document.querySelector("#notename");
		if (nelement) {
			nelement.innerHTML = interval;
		}

		let relement = document.querySelector("#ratioscore");
		if (relement) {
			relement.textContent = rscore;
			relement.style.display = "block";
		}

		event.preventDefault();
	}

});


</script>



