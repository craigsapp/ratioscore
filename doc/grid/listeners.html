
<script>
// vim: ts=3:ft=javascript

let AUDIOcache       = {};
let AUDIOsequence    = [];
let AUDIOseqname     = [];
let AUDIOratiolist   = [];

let DEFAULTS = {
	"rows": 10,
	"columns": 10,
	"reference": "C4",
	"playref": 1,
	"instrument": 71,
	"duration": 2,
	"reduce": 0
};

let SETTINGS = {};


document.addEventListener("DOMContentLoaded", function () {
	loadDefaultSettings();
	loadCgiSettings();

	let inputs = document.querySelectorAll("input");
	for (let i=0; i<inputs.length; i++) {
		if (inputs[i].type === "checkbox") {
			inputs[i].addEventListener("click", generateGrid);
		} else {
			inputs[i].addEventListener("keyup", generateGrid);
		}
	}

	let selects = document.querySelectorAll("select");
	for (let i=0; i<selects.length; i++) {
		selects[i].addEventListener("change", generateGrid);
	}

	updateInputsFromSettings();
	generateGrid();
});


//////////////////////////////
//
// play event delegator --
//

document.addEventListener("click", function (event) {
	let target = event.target;
	let interval = "XXX";
	let cents = "XXX";
	let freq = "XXX";
	let midikey = "XXX";

	while (target) {
		if (target.nodeName === "BODY") {
			break;
		}
		if (target.nodeName !== "TD") {
			target = target.parentNode;
			continue;
		}
		if (target.classList.contains("playinterval")) {
			interval = target.textContent;
			break;
		}
		if (target.classList.contains("playcents")) {
			cents = target.textContent;
			break;
		}
		if (target.classList.contains("playhz")) {
			freq = target.textContent;
			break;
		}
		if (target.classList.contains("playmidikey")) {
			midikey = target.textContent;
			break;
		}
		target = target.parentNode;
	}

	if ((interval === cents) && (interval === midikey) && (interval === freq)) {
		return;
	}
	if (interval !== "XXX") {
		playInterval(interval);
	} else if (cents !== "XXX") {
		playCents(cents);
	} else if (freq !== "XXX") {
		playHz(freq);
	} else if (midikey !== "XXX") {
		playMidiKey(midikey);
	}
});



//////////////////////////////
//
// keypress event handlers --
//

document.addEventListener("keydown", function (event) {
	// console.log("KEY", event.key);
	let target = event.target;
	if (target.nodeName === "INPUT") {
		return;
	}
	if (event.metaKey) {
		return;
	}
	if (event.key === "Meta") {
		return;
	}

	if (event.key === "Backspace") {
		// Clear mapping sounds to computer keys.
		AUDIOsequence = [];
		AUDIOseqname = [];
		AUDIOratiolist = [];
		var notename = document.querySelector("#notename");
		if (notename) {
			notename.innerHTML = "";
		}
		var ratiotext = document.querySelector("#ratioscore");
		if (ratiotext) {
			ratiotext.innerHTML = "";
			relement.style.display = "none";
		}
		event.preventDefault();
		return;
	}

	let sequence = {};
	sequence["1"] = 0;
	sequence["2"] = 1;
	sequence["3"] = 2;
	sequence["4"] = 3;
	sequence["5"] = 4;
	sequence["6"] = 5;
	sequence["7"] = 6;
	sequence["8"] = 7;
	sequence["9"] = 8;
	sequence["0"] = 9;
	sequence["-"] = 10;
	sequence["="] = 11;
	sequence["q"] = 12;
	sequence["w"] = 13;
	sequence["e"] = 14;
	sequence["r"] = 15;
	sequence["t"] = 16;
	sequence["y"] = 17;
	sequence["u"] = 18;
	sequence["i"] = 19;
	sequence["o"] = 20;
	sequence["p"] = 21;
	sequence["["] = 22;
	sequence["]"] = 23;
	sequence["\\"] = 24;
	sequence["a"] = 25;
	sequence["s"] = 26;
	sequence["d"] = 27;
	sequence["f"] = 28;
	sequence["g"] = 29;
	sequence["h"] = 30;
	sequence["j"] = 31;
	sequence["k"] = 32;
	sequence["l"] = 33;
	sequence[";"] = 34;
	sequence["'"] = 35;
	sequence["z"] = 36;
	sequence["x"] = 37;
	sequence["c"] = 38;
	sequence["v"] = 39;
	sequence["b"] = 40;
	sequence["n"] = 41;
	sequence["m"] = 42;
	sequence[","] = 43;
	sequence["."] = 44;
	sequence["/"] = 45;

	if (AUDIOsequence[sequence[event.key]]) {
		playMp3Url(AUDIOcache[AUDIOsequence[sequence[event.key]]]);
		let interval = AUDIOseqname[sequence[event.key]];
		let rscore = AUDIOratiolist[sequence[event.key]];

		let nelement = document.querySelector("#notename");
		if (nelement) {
			nelement.innerHTML = interval;
		}

		let relement = document.querySelector("#ratioscore");
		if (relement) {
			relement.textContent = rscore;
			relement.style.display = "block";
		}

		event.preventDefault();
	}

});


</script>



