
<script>
{% include_relative aton.js %}
{% include_relative RationalNumber-base.js %}
{% include_relative RationalNumber-math.js %}
</script>



<script>
// vim: ts=3:ft=javascript


//////////////////////////////
//
// getAtonContent --
//

function getAtonContent(id) {
	let element = document.querySelector("#" + id);
	if (!element) {
		console.log("CANNOT FIND ELEMENT WITH ID =", id);
		return [];
	}
	let text = element.textContent;
	let aton = new ATON;
	return aton.parse(text);

}


//////////////////////////////
//
// getComposerList --
//

function getComposerList(songlist) {
	let output = {};
	for (let i=0; i<songlist.length; i++) {
		let entry = songlist[i];
		let composer = entry.COMPOSER;
		let centry = output[composer];
		if (!centry) {
			centry = {};
			centry.composer = composer;
			centry.songs = [];
			output[composer] = centry;
		}
		centry.songs.push(entry);
	}
	return output;
}



//////////////////////////////
//
// getFileInfo --
//

function getFileInfo(songlist) {
	let output = {};
	for (let i=0; i<songlist.length; i++) {
		let entry = songlist[i];
		let file = entry.FILE;
		output[file] = entry;
	}
	return output
}




//////////////////////////////
//
// loadMu2File --
//

function loadMu2File(urlbase, pdfbase, filebase, urlbase2) {
	let url = urlbase + "/" + filebase + ".mu2";
	let request = new XMLHttpRequest();
	request.onload = function () {
		if (request.readyState == request.DONE) {
			if (request.status == 200) {
				let ratioscore = convertMu2FileToRatioscore(request.responseText, filebase);
				let target = document.querySelector("#main");
				if (!target) {
					console.log("PROBLEM FINDING #main");
					return;
				}
				let target2 = document.querySelector("#inputdata-main");
				if (!target2) {
					console.log("PROBLEM FINDING #inputdata-main");
					return;
				}
				target.textContent = ratioscore;
				target2.textContent = ratioscore;
				if (CGI.autoplay) {
					delete CGI.autoplay;
					PlayAudioFile('main');
				}
			}
		}
	};
	request.open("GET", url);
	request.send();
	
	let pdfelement = document.querySelector("#pdf");
	if (!pdfelement) {
		return;
	}
	let output = "<a target='symbtr-pdf' href='";
	output += pdfbase + "/" + filebase + ".pdf";
	output += "'>";
	output += "PDF of graphical score";
	output += "</a>";
	output += " | ";
	output += "<a target='symbtr-mu2' href='";
	output += urlbase2 + "/" + filebase + ".mu2";
	output += "'>";
	output += "Mu2 digital score";
	output += "</a>";
	pdfelement.innerHTML = output;
}



//////////////////////////////
//
// buildSongSelect --
//

function buildSongSelect(songlist) {
	let songindex = 1943
	if (CGI.autoplay) {
		if (CGI.autoplay.match(/^\d+$/)) {
			songindex = parseInt(CGI.autoplay) - 1;
		}
	} else if (CGI.n) {
		if (CGI.n.match(/^\d+$/)) {
			songindex = parseInt(CGI.n) - 1;
		}
	}

	if (!songlist) {
		songlist = WORKLIST.SONGLIST.SONG;
	}
	var element = document.querySelector("#songlist");
	if (!element) {
		return;
	}
	let output = "<select id='songselect' onchange='playSong(event)'>";
	for (let i=0; i<songlist.length; i++) {
		output += "<option value='" + (i+1) + "'";
		if (i == songindex) {
			output += " selected";
		}
		output += ">";
		output += (i+1) + ". ";
		if (songlist[i].TITLE) {
			output += songlist[i].TITLE;
		}
		if (songlist[i].COMPOSER && (!songlist[i].COMPOSER.match(/^\s*\?\s*$/))) {
			output += ", by " + songlist[i].COMPOSER.replace(/^\(/, "").replace(/\)$/, "");;
		}
		output += "</option>";
	}
	output += "</select>\n";

	element.innerHTML = output;
	if (CGI.autoplay) {
		playSong();
	}
}



//////////////////////////////
//
// playSong --
//

function playSong(event) {
	let target = document.querySelector("#songselect");
	if (!target) {	
		target = event.target;
	}
	let songnumber = parseInt(target.value);
	songnumber--;
	loadMu2File(WORKLIST.MU2URLBASE, WORKLIST.PDFURLBASE, WORKLIST.SONGLIST.SONG[songnumber].FILE, WORKLIST.MU2URLBASE2);
}



//////////////////////////////
//
// addComposerInfoToComposerList --
//

function	addComposerInfoToComposerList(list, info) {
	for (let i=0; i<info.length; i++) {
		let entry = info[i];
		let composer = entry.COMPOSER;
		let cdt = entry.CDT;
		let wikipedia = entry.WIKIPEDIA;
		if (cdt) {
			list[composer].CDT = cdt;
		}
		if (wikipedia) {
			list[composer].WIKIPEDIA = wikipedia;
		}
	}
}



</script>






